<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudWatch Analysis Dashboard - {{ batch_name }}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .header-meta {
      opacity: 0.9;
      font-size: 0.95rem;
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
    }

    /* Health Score Card */
    .health-score-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .health-score {
      font-size: 4rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .health-score.excellent {
      color: #27ae60;
    }

    .health-score.good {
      color: #2ecc71;
    }

    .health-score.fair {
      color: #f39c12;
    }

    .health-score.poor {
      color: #e74c3c;
    }

    .health-label {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 1rem;
    }

    .health-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .metric {
      text-align: center;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .metric-value.success {
      color: #27ae60;
    }

    .metric-value.failed {
      color: #e74c3c;
    }

    .metric-value.lost {
      color: #e67e22;
    }

    .metric-value.progress {
      color: #3498db;
    }

    .metric-label {
      color: #666;
      font-size: 0.9rem;
    }

    /* Navigation Tabs */
    .main-nav {
      display: flex;
      background: white;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 0;
      overflow: hidden;
    }

    .nav-tab {
      flex: 1;
      padding: 1.2rem;
      text-align: center;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .nav-tab:hover {
      background: #e9ecef;
    }

    .nav-tab.active {
      background: white;
      border-bottom-color: #3498db;
      color: #3498db;
    }

    /* Content Area */
    .content-area {
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-height: 500px;
    }

    .tab-content {
      display: none;
      padding: 2rem;
    }

    .tab-content.active {
      display: block;
    }

    /* Quick Filters */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-select,
    .filter-input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    /* Status Cards */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .status-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .status-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .status-card.success {
      border-left: 4px solid #27ae60;
    }

    .status-card.failed {
      border-left: 4px solid #e74c3c;
    }

    .status-card.lost {
      border-left: 4px solid #e67e22;
    }

    .status-card.progress {
      border-left: 4px solid #3498db;
    }

    .status-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-count {
      font-size: 1.5rem;
      font-weight: bold;
    }

    /* Job Lists */
    .job-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 6px;
    }

    .job-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #f8f9fa;
      transition: background-color 0.2s ease;
    }

    .job-item:hover {
      background-color: #f8f9fa;
    }

    .job-item:last-child {
      border-bottom: none;
    }

    .job-info {
      flex: 1;
    }

    .job-stream {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }

    .job-stream a {
      color: #3498db;
      text-decoration: none;
    }

    .job-stream a:hover {
      text-decoration: underline;
    }

    .job-timestamp {
      color: #666;
      font-size: 0.8rem;
    }

    .job-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .job-status.failed {
      background: #fee;
      color: #c0392b;
    }

    .job-status.lost {
      background: #fef5e7;
      color: #d68910;
    }

    .job-status.succeeded {
      background: #eafaf1;
      color: #27ae60;
    }

    /* Error Analysis */
    .error-pattern {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .error-header {
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .error-header:hover {
      background: #f8f9fa;
    }

    .error-title {
      font-weight: 600;
      color: #2c3e50;
    }

    .error-count {
      background: #e74c3c;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .error-details {
      padding: 1rem;
      background: #f8f9fa;
      display: none;
    }

    .error-details.active {
      display: block;
    }

    .error-pattern-text {
      background: #fff;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      color: #2c3e50;
      border: 1px solid #ddd;
      margin-bottom: 1rem;
      white-space: pre-wrap;
    }

    .affected-jobs {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 0.5rem;
    }

    .affected-job {
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
    }

    /* Action Items */
    .action-items {
      display: grid;
      gap: 1rem;
    }

    .action-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1.5rem;
    }

    .action-item.critical {
      border-left: 4px solid #e74c3c;
      background: #fdf2f2;
    }

    .action-item.high {
      border-left: 4px solid #f39c12;
      background: #fefcf3;
    }

    .action-item.medium {
      border-left: 4px solid #3498db;
      background: #f7fbff;
    }

    .action-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .priority-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .priority-badge.critical {
      background: #e74c3c;
      color: white;
    }

    .priority-badge.high {
      background: #f39c12;
      color: white;
    }

    .priority-badge.medium {
      background: #3498db;
      color: white;
    }

    .action-description {
      color: #666;
      margin-bottom: 1rem;
    }

    .action-recommendations {
      list-style: none;
    }

    .action-recommendations li {
      padding: 0.25rem 0;
      position: relative;
      padding-left: 1.5rem;
    }

    .action-recommendations li:before {
      content: "â†’";
      position: absolute;
      left: 0;
      color: #3498db;
      font-weight: bold;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        padding: 1.5rem;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .main-nav {
        flex-direction: column;
      }

      .nav-tab {
        padding: 1rem;
      }

      .health-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .status-grid {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-1 {
      margin-top: 0.5rem;
    }

    .mt-2 {
      margin-top: 1rem;
    }

    .mb-1 {
      margin-bottom: 0.5rem;
    }

    .mb-2 {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>CloudWatch Analysis Dashboard</h1>
      <div class="header-meta">
        <span><strong>Batch:</strong> {{ batch_name }}</span>
        {% if collection %}
        <span><strong>Collection:</strong> {{ collection }}</span>
        {% endif %}
        <span><strong>Analysis Time:</strong> {{ analysis_timestamp }}</span>
        <span><strong>Time Range:</strong> Last {{ time_range_days }} days</span>
      </div>
    </div>

    <!-- Health Score Card -->
    {% if executive_summary %}
    <div class="health-score-card">
      <div
        class="health-score {{ 'excellent' if executive_summary.health_metrics.overall_health_score >= 90 else 'good' if executive_summary.health_metrics.overall_health_score >= 75 else 'fair' if executive_summary.health_metrics.overall_health_score >= 50 else 'poor' }}">
        {{ executive_summary.health_metrics.overall_health_score }}
      </div>
      <div class="health-label">Overall Health Score</div>

      <div class="health-metrics">
        <div class="metric">
          <div class="metric-value success">{{ "%.1f"|format(executive_summary.health_metrics.success_rate) }}%</div>
          <div class="metric-label">Success Rate</div>
        </div>
        <div class="metric">
          <div class="metric-value failed">{{ executive_summary.status_breakdown.failed }}</div>
          <div class="metric-label">Failed Jobs</div>
        </div>
        <div class="metric">
          <div class="metric-value lost">{{ executive_summary.status_breakdown.lost }}</div>
          <div class="metric-label">Infrastructure Issues</div>
        </div>
        <div class="metric">
          <div class="metric-value progress">{{ executive_summary.status_breakdown.in_progress }}</div>
          <div class="metric-label">In Progress</div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Main Navigation -->
    <div class="main-nav">
      <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
      <button class="nav-tab" onclick="showTab('failures')">Failures Analysis</button>
      <button class="nav-tab" onclick="showTab('patterns')">Error Patterns</button>
      <button class="nav-tab" onclick="showTab('actions')">Action Items</button>
    </div>

    <div class="content-area">
      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <h2>CloudWatch Logs Overview</h2>

        <div class="status-grid">
          <div class="status-card success">
            <div class="status-title">
              Successful Jobs
              <span class="status-count">{{ status_groups.success|length if status_groups else 0 }}</span>
            </div>
            <div class="mt-1">{{ "%.1f"|format(summary.success_rate if summary else 0) }}% of total jobs</div>
          </div>

          <div class="status-card failed">
            <div class="status-title">
              Application Failures
              <span class="status-count">{{ status_groups.application_failures|length if status_groups else 0 }}</span>
            </div>
            <div class="mt-1">{{ "%.1f"|format(summary.failure_rate if summary else 0) }}% of total jobs</div>
          </div>

          <div class="status-card lost">
            <div class="status-title">
              Infrastructure Issues
              <span class="status-count">{{ status_groups.infrastructure_issues|length if status_groups else 0 }}</span>
            </div>
            <div class="mt-1">{{ "%.1f"|format(summary.infrastructure_failure_rate if summary else 0) }}% of total jobs
            </div>
          </div>

          <div class="status-card progress">
            <div class="status-title">
              In Progress
              <span class="status-count">{{ status_groups.in_progress|length if status_groups else 0 }}</span>
            </div>
            <div class="mt-1">Jobs still running or pending</div>
          </div>
        </div>

        {% if trend_analysis and trend_analysis.trend_available %}
        <h3>Performance Trends</h3>
        <div class="status-grid">
          <div class="status-card">
            <div class="status-title">Success Rate Trend</div>
            <div class="mt-1">
              Current: {{ trend_analysis.metrics.success_rate.current }}%<br>
              Average: {{ trend_analysis.metrics.success_rate.average }}%<br>
              Trend: {{ trend_analysis.metrics.success_rate.trend.title() }}
            </div>
          </div>
          <div class="status-card">
            <div class="status-title">Infrastructure Health</div>
            <div class="mt-1">
              Current Failures: {{ trend_analysis.metrics.infrastructure_failures.current }}%<br>
              Trend: {{ trend_analysis.metrics.infrastructure_failures.trend.title() }}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Failures Analysis Tab -->
      <div id="failures" class="tab-content">
        <h2>Failures Analysis</h2>

        <div class="filters">
          <div class="filter-group">
            <label>Filter by Status:</label>
            <select class="filter-select" id="statusFilter" onchange="filterJobs()">
              <option value="all">All Failures</option>
              <option value="FAILED">Application Failures</option>
              <option value="LOST">Infrastructure Issues</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Search Jobs:</label>
            <input type="text" class="filter-input" id="jobSearch" placeholder="Job stream name..."
              onkeyup="filterJobs()">
          </div>
        </div>

        <div class="job-list" id="failedJobsList">
          {% for job in status_groups.application_failures + status_groups.infrastructure_issues if status_groups %}
          <div class="job-item" data-status="{{ job.job_status }}" data-stream="{{ job.job_log_stream }}">
            <div class="job-info">
              <div class="job-stream">
                <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups/log-group/{{ job.job_log_stream|replace('/', '$252F') }}"
                  target="_blank">
                  {{ job.job_log_stream }}
                </a>
              </div>
              <div class="job-timestamp">{{ job.timestamp }}</div>
              <div class="mt-1">
                <strong>Pipeline:</strong>
                <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups/log-group/{{ job.pipeline_log_stream|replace('/', '$252F') }}"
                  target="_blank">
                  {{ job.pipeline_log_stream }}
                </a>
              </div>
            </div>
            <div class="job-status {{ job.job_status.lower() }}">{{ job.job_status }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Error Patterns Tab -->
      <div id="patterns" class="tab-content">
        <h2>Error Patterns</h2>
        <p class="mb-2">Deduplicated error patterns with occurrence counts and affected jobs.</p>

        {% for error in unique_errors %}
        <div class="error-pattern">
          <div class="error-header" onclick="toggleErrorDetails({{ loop.index0 }})">
            <div class="error-title">{{ error.error_pattern[:100] }}{% if error.error_pattern|length > 100 %}...{% endif
              %}</div>
            <div class="error-count">{{ error.occurrence_count }} jobs</div>
          </div>
          <div class="error-details" id="error-details-{{ loop.index0 }}">
            <div class="error-pattern-text">{{ error.error_pattern }}</div>
            <div class="mb-1"><strong>Error Type:</strong> {{ error.error_type }}</div>
            <div class="mb-1"><strong>First Occurrence:</strong> {{ error.first_occurrence_timestamp }}</div>
            <div class="mb-2"><strong>Affected Jobs ({{ error.occurrence_count }}):</strong></div>
            <div class="affected-jobs">
              {% for job_stream in error.affected_job_streams %}
              <div class="affected-job">
                <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups/log-group/{{ job_stream|replace('/', '$252F') }}"
                  target="_blank">
                  {{ job_stream }}
                </a>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Action Items Tab -->
      <div id="actions" class="tab-content">
        <h2>Action Items</h2>
        <p class="mb-2">Prioritized recommendations to improve batch processing performance.</p>

        {% if executive_summary and executive_summary.potential_improvements %}
        <div class="action-item">
          <div class="action-title">
            <span class="priority-badge medium">POTENTIAL</span>
            Performance Improvement Opportunity
          </div>
          <div class="action-description">
            By addressing the issues below, you could potentially recover {{
            executive_summary.potential_improvements.recoverable_jobs }} jobs
            and improve success rate from {{ executive_summary.potential_improvements.current_success_rate }}%
            to {{ executive_summary.potential_improvements.potential_success_rate }}%.
          </div>
        </div>
        {% endif %}

        <div class="action-items">
          {% for action in action_items %}
          <div class="action-item {{ action.priority.lower() }}">
            <div class="action-title">
              <span class="priority-badge {{ action.priority.lower() }}">{{ action.priority }}</span>
              {{ action.issue }}
            </div>
            <div class="action-description">
              <strong>Category:</strong> {{ action.category }}<br>
              {{ action.recommendation }}
              {% if action.affected_jobs > 0 %}
              <br><strong>Impact:</strong> {{ action.affected_jobs }} jobs affected
              {% endif %}
            </div>
            {% if action.actions %}
            <ul class="action-recommendations">
              {% for recommendation in action.actions %}
              <li>{{ recommendation }}</li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <script>
    function showTab(tabName) {
      // Hide all tab contents
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));

      // Remove active class from all tabs
      const tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(tab => tab.classList.remove('active'));

      // Show selected tab content
      document.getElementById(tabName).classList.add('active');

      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    function toggleErrorDetails(index) {
      const details = document.getElementById(`error-details-${index}`);
      details.classList.toggle('active');
    }

    function filterJobs() {
      const statusFilter = document.getElementById('statusFilter').value;
      const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
      const jobItems = document.querySelectorAll('.job-item');

      jobItems.forEach(item => {
        const status = item.getAttribute('data-status');
        const stream = item.getAttribute('data-stream').toLowerCase();

        const statusMatch = statusFilter === 'all' || status === statusFilter;
        const searchMatch = searchTerm === '' || stream.includes(searchTerm);

        if (statusMatch && searchMatch) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
      // Set initial active tab
      showTab('overview');
    });
  </script>
</body>

</html>